import React, { useState, useEffect } from "react";
import { MapContainer, TileLayer, Polyline } from "react-leaflet";
import "leaflet/dist/leaflet.css";

const generarVuelos = (origenes, destinos, horaInicio, horaFin, precio, cantidad) => {
  return Array.from({ length: cantidad }, () => {
    const origen = origenes[Math.floor(Math.random() * origenes.length)];
    const destino = destinos[Math.floor(Math.random() * destinos.length)];
    return { origen, destino, horaInicio, horaFin, precio };
  });
};

const vuelos = [
  ...generarVuelos(["Argentina", "Chile", "Brasil"], ["Colombia", "Perú", "Ecuador"], 1, 6, 50000, 30),
  ...generarVuelos(["México", "EE.UU.", "Canadá"], ["Guatemala", "Panamá", "Costa Rica"], 6, 12, 100000, 30),
  ...generarVuelos(["España", "Francia", "Italia"], ["Alemania", "Portugal", "Reino Unido"], 13, 17, 400000, 30),
  ...generarVuelos(["Japón", "China", "India"], ["Australia", "Corea del Sur", "Filipinas"], 18, 23, 500000, 30),
];

const obtenerHoraAleatoria = (inicio, fin) => {
  return Math.floor(Math.random() * (fin - inicio + 1)) + inicio;
};

export default function App() {
  const [pais, setPais] = useState("");
  const [menuVisible, setMenuVisible] = useState(false);
  const [saldo, setSaldo] = useState(100000);
  const [horaActual, setHoraActual] = useState(new Date().getHours());
  const [vueloSeleccionado, setVueloSeleccionado] = useState(null);
  const [cargando, setCargando] = useState(false);

  useEffect(() => {
    const interval = setInterval(() => {
      setHoraActual(new Date().getHours());
    }, 60000);
    return () => clearInterval(interval);
  }, []);

  const manejarSeleccion = () => {
    setMenuVisible(true);
  };

  const manejarCompra = (vuelo) => {
    if (saldo >= vuelo.precio) {
      setSaldo(saldo - vuelo.precio);
      alert("Pago exitoso");
    } else {
      alert("Error: saldo insuficiente");
    }
  };

  const manejarVueloSeleccionado = (vuelo) => {
    setCargando(true);
    setTimeout(() => {
      setVueloSeleccionado(vuelo);
      setCargando(false);
    }, 5000);
  };

  return (
    <div className="App">
      {!menuVisible ? (
        <div>
          <h1>Selecciona tu país</h1>
          <input
            type="text"
            placeholder="Escribe tu país"
            value={pais}
            onChange={(e) => setPais(e.target.value)}
          />
          <button onClick={manejarSeleccion}>Iniciar</button>
        </div>
      ) : cargando ? (
        <div>
          <h1>Cargando...</h1>
          <img src="/avion-volando.gif" alt="Avión volando" style={{ width: "200px" }} />
        </div>
      ) : vueloSeleccionado ? (
        <div>
          <h1>Ruta del vuelo</h1>
          <p>{vueloSeleccionado.origen} - {vueloSeleccionado.destino}</p>
          <MapContainer center={[0, 0]} zoom={2} style={{ height: "400px", width: "100%" }}>
            <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" />
            <Polyline positions={[[0, 0], [20, 20]]} color="blue" />
          </MapContainer>
          <button onClick={() => setVueloSeleccionado(null)}>Volver</button>
        </div>
      ) : (
        <div>
          <h1>Vuelos disponibles</h1>
          <h2>Saldo: {saldo} COP</h2>
          <h2>Hora actual: {horaActual}:00</h2>
          {vuelos.map((vuelo, index) => {
            const horaSalida = obtenerHoraAleatoria(vuelo.horaInicio, vuelo.horaFin);
            const yaDespego = horaActual > horaSalida;
            return (
              <div key={index} style={{ border: "1px solid black", padding: 10, margin: 5 }}>
                <h3>Vuelo: {vuelo.origen} - {vuelo.destino}</h3>
                <p>Hora de salida: {horaSalida}:00 {yaDespego && <span style={{ color: "red" }}>Despegó</span>}</p>
                <p>Precio: {vuelo.precio} COP</p>
                <img src="/avion.png" alt="Avión en pista" style={{ width: "100px" }} />
                <button onClick={() => manejarCompra(vuelo)}>Comprar</button>
                <button onClick={() => manejarVueloSeleccionado(vuelo)}>Ver Ruta</button>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}
